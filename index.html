<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>AR su piano reale</title>
    <script src="https://aframe.io/releases/1.4.2/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/aframe-extras@6.1.1/dist/aframe-extras.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/aframe-ar@1.8.0/dist/aframe-ar.min.js"></script>
    <style>
      body { margin: 0; overflow: hidden; }
    </style>
  </head>
  <body>
    <a-scene
      vr-mode-ui="enabled: false"
      embedded
      arjs="sourceType: webcam; debugUIEnabled: false;"
      renderer="logarithmicDepthBuffer: true;"
      webxr="optionalFeatures: hit-test; requiredFeatures: hit-test;"
    >
      <a-assets>
        <a-asset-item id="model" src="model.glb"></a-asset-item>
      </a-assets>

      <a-entity camera look-controls></a-entity>

      <a-entity
        id="reticle"
        geometry="primitive: ring; radiusInner: 0.05; radiusOuter: 0.06;"
        material="color: green; shader: flat;"
        position="0 0 -1"
        visible="false"
      ></a-entity>

      <a-entity id="model-container"></a-entity>
    </a-scene>

    <script>
      let modelPlaced = false;

      AFRAME.registerComponent("ar-hit-test", {
        init: function () {
          const sceneEl = this.el.sceneEl;
          const reticle = document.querySelector("#reticle");
          const modelContainer = document.querySelector("#model-container");

          sceneEl.addEventListener("enter-vr", () => {
            const xrSession = sceneEl.renderer.xr.getSession();

            xrSession.requestReferenceSpace("viewer").then((refSpace) => {
              xrSession.requestHitTestSource({ space: refSpace }).then((hitTestSource) => {
                sceneEl.renderer.xr.setAnimationLoop((timestamp, frame) => {
                  const viewerPose = frame.getViewerPose(sceneEl.renderer.xr.getReferenceSpace());
                  if (viewerPose) {
                    const hitTestResults = frame.getHitTestResults(hitTestSource);
                    if (hitTestResults.length > 0 && !modelPlaced) {
                      const hit = hitTestResults[0];
                      const pose = hit.getPose(sceneEl.renderer.xr.getReferenceSpace());
                      reticle.object3D.position.copy(pose.transform.position);
                      reticle.object3D.visible = true;
                    }
                  }
                });
              });
            });

            sceneEl.addEventListener("click", () => {
              if (!modelPlaced && reticle.object3D.visible) {
                const model = document.createElement("a-gltf-model");
                model.setAttribute("src", "#model");
                model.setAttribute("position", reticle.object3D.position);
                model.setAttribute("scale", "0.5 0.5 0.5");
                modelContainer.appendChild(model);
                modelPlaced = true;
              }
            });
          });
        },
      });

      document.querySelector("a-scene").setAttribute("ar-hit-test", "");
    </script>
  </body>
</html>
